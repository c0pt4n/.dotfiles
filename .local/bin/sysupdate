#!/bin/sh

set -eu

# shellcheck disable=2015
sudocmd="$([ -f /etc/doas.conf ] && command -v doas 2>/dev/null || command -v sudo 2>/dev/null)"

updatepkgs() {
	$sudocmd xbps-install -Sy &&
		$sudocmd xbps-install -uy xbps &&
		$sudocmd xbps-install -uy
	command -v flatpak >/dev/null 2>&1 && flatpak update -y
	command -v go >/dev/null 2>&1 && xargs -a ~/.local/share/meta/pkgs_go.txt -I {} go install -v {}
	command -v xlocate && xlocate -S
}

clean() {
	$sudocmd xbps-remove -Ooy
	$sudocmd vkpurge rm all
	command -v nix >/dev/null 2>&1 &&
		nix-collect-garbage &&
		nix-store --optimise
}

case "${1:-pkgs}" in
	pkgs) updatepkgs ;;
	clean) clean ;;
	*)
		echo "$(basename "$0"): unknown command: $1" >&2
		exit 1
		;;
esac
