#!/bin/sh

set -eu

VOLUMECTL_LIMIT="${VOLUMECTL_LIMIT:-1.3}"

getvol() {
	vol="$(wpctl get-volume @DEFAULT_AUDIO_SINK@)"
	[ -n "$vol" ] || return 1
	[ "$vol" != "${vol%\[MUTED\]}" ] && {
		echo "muted"
		return 0
	}
	numfmt --from-unit=100 --format="%.0f" "${vol#Volume: }"
}

case "${1:-get}" in
	set) wpctl set-volume @DEFAULT_AUDIO_SINK@ "${2:-60}%" ;;
	get)
		vol="$(getvol)" || exit $?
		echo "$vol%"
		;;
	toggle)
		wpctl set-mute @DEFAULT_AUDIO_SINK@ toggle
		;;
	*+ | *- | *%)
		wpctl set-mute @DEFAULT_AUDIO_SINK@ 0
		wpctl set-volume @DEFAULT_AUDIO_SINK@ "$1" --limit "$VOLUMECTL_LIMIT"
		;;
    togglemic)
        wpctl set-mute @DEFAULT_AUDIO_SOURCE@ toggle

		if wpctl get-volume @DEFAULT_AUDIO_SOURCE@ | grep -q '\[MUTED\]'; then
			notify-send \
				-u low \
				-t 1000 \
				-a "$(basename "$0")" \
				-h "string:x-canonical-private-synchronous:mic" \
				"Microphone" \
				"Muted"
		else
			notify-send \
				-u low \
				-t 1000 \
				-a "$(basename "$0")" \
				-h "string:x-canonical-private-synchronous:mic" \
				"Microphone" \
				"Unmuted"
		fi

		exit 0
		;;
	*)
		echo "$(basename): invalid command: $1" >&2
		exit 1
		;;
esac

vol="$(getvol)" || exit $?
text="$vol%"
[ "$vol" = "muted" ] && {
	vol=0
	text="muted"
}
notify-send \
	-u low \
	-t 1000 \
	-a "$(basename "$0")" \
	-h "int:value:$vol" \
	-h "string:x-canonical-private-synchronous:volume" \
	"volume" \
	"$text"
